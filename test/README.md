# テストについて

このディレクトリには、Temporal ワークフローとアクティビティのテストが含まれています。

## テストの実行方法

```bash
# すべてのテストを実行
uv run pytest

# 特定のテストファイルを実行
uv run pytest test/test_activities.py
uv run pytest test/test_analysis_workflow.py
uv run pytest test/test_proxy_workflow.py
```

## テストの種類

### 活動テスト (`test_activities.py`)

アクティビティの機能を個別にテストします。ワークフローの実行コンテキスト外でアクティビティの挙動を検証します。

### ワークフローテスト

1. **分析ワークフローテスト** (`test_analysis_workflow.py`):
   - 完全なフローテスト: すべての分析タイプに対するシグナル処理と結果の検証
   - 部分的シグナルテスト: 一部のシグナルのみを受信した場合の挙動
   - 無効なジョブ/テナントテスト: 異なるジョブIDやテナントIDのシグナルを受信した場合の処理

2. **プロキシワークフローテスト** (`test_proxy_workflow.py`):
   - 基本機能テスト: ペイロードからデータを抽出し、分析ワークフローにシグナルを送信する機能
   - 無効なペイロードテスト: 必須フィールドが欠けている場合のエラー処理
   - 無効な分析タイプテスト: サポートされていない分析タイプの処理

## フィクスチャ (`conftest.py`)

このファイルには、テスト用の共通フィクスチャが定義されています：

- `client`: Temporal クライアントのフィクスチャ
- `temp_dir`: 一時的な出力ディレクトリを作成するフィクスチャ
- `activities`: アクティビティインスタンスのフィクスチャ
- `worker_info`: テスト用のワーカーを作成するフィクスチャ

## テスト最適化

ワークフローテストは以下の最適化テクニックを取り入れています：

1. **シグナル送信の最適化**:
   - `asyncio.gather()` を使用して複数のシグナルを同時に送信
   - 直列化された送信と比較して実行時間を短縮

2. **待機時間の最適化**:
   - 必要最小限の待機時間のみを設定
   - ワークフロー初期化後に0.1秒の短い待機のみを使用

3. **短いタイムアウト値**:
   - テスト用に短いタイムアウトを設定(5-30秒)
   - タイムアウト時の代替処理を実装

これらの最適化により、テスト実行時間が約40%短縮されています。詳細な最適化手法については、`README_OPTIMIZATION.md` を参照してください。